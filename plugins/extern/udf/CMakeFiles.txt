
execute_process(
COMMAND ./configure --prefix=${CMAKE_INSTALL_PREFIX}/troysql --enable-embed=shared --enable-bcmath --enable-calendar --with-mysql=mysqlnd --enable-embedded-mysqli --enable-mysqlnd --enable-maintainer-zts --enable-zend-multibyte --with-tsrm-pthreads
WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/extern/php-5.3.29/
RESULT_VARIABLE PHP_CONF_RESULT
)

if(${PHP_CONF_RESULT} GREATER 0)
  message( FATAL_ERROR "PHP 5.3.29 could not be configured." )
endif()

execute_process(
COMMAND make -j
WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/extern/php-5.3.29/
RESULT_VARIABLE PHP_MAKE_RESULT
)

if(${PHP_CONF_RESULT} GREATER 0)
  message( FATAL_ERROR "PHP 5.3.29 could not be built. ") 
endif()

FIND_LIBRARY(PHP_LOC php5 PATHS ${CMAKE_SOURCE_DIR}/warpsql/extern/php-5.3.29/libs ${PLUGINDIR})

INCLUDE_DIRECTORIES(
  ${CMAKE_SOURCE_DIR}/warpsql/phpembed/src
  ${CMAKE_SOURCE_DIR}/warpsql/extern/php-5.3.29/
  ${CMAKE_SOURCE_DIR}/warpsql/extern/php-5.3.29/include
  ${CMAKE_SOURCE_DIR}/warpsql/extern/php-5.3.29/main
  ${CMAKE_SOURCE_DIR}/warpsql/extern/php-5.3.29/sapi/embed
  ${CMAKE_SOURCE_DIR}/warpsql/extern/php-5.3.29/Zend
  ${CMAKE_SOURCE_DIR}/warpsql/extern/php-5.3.29/TSRM
) 

ADD_LIBRARY(php5 SHARED IMPORTED)
SET_TARGET_PROPERTIES(php5 PROPERTIES IMPORTED_LOCATION ${PHP_LOC} )

add_library(phpembed SHARED ${phpembed_LIB_SRCS})
set_target_properties(phpembed PROPERTIES VERSION 4.2.0 SOVERSION 4)
target_link_libraries(phpembed php5)


install(TARGETS phpembed DESTINATION ${PLUGINDIR})
