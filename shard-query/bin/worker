#!/usr/bin/php
<?php
require_once 'bin_common.php';
require_once 'Net/Gearman/Worker.php';
require_once 'shard-query.php';
require_once 'DAL/simple-dal.php';
ini_set('memory_limit','-1');
if($argc < 2) {
  echo "usage: worker <store_resultset|shard_query_worker|custom_function|new_loader|splitter>'\n";
  exit(-1);
}
$type = $argv[1];

try {
	  require_once('shard-query-config.php');

	  $db = SimpleDal::factory($config_database);
	  $db->my_select_db($config_database['db']);
	  $sql = "select * from gearman_job_servers join schemata on schemata.id = schema_id where schema_name = '" . $config_database['default_virtual_schema'] . "'" ;
	  $stmt = $db->my_query($sql);
	  $gearman_servers = "";
	  while($row = $db->my_fetch_assoc()) {
	  	if($gearman_servers) $gearman_servers .= ",";
	  	$gearman_servers .= $row['hostname'] . ":" . $row['port'];
	  }
	
    $worker = new Net_Gearman_Worker($gearman_servers);
    $worker->addAbility($type);
    $worker->beginWork();
} catch (Net_Gearman_Exception $e) {
    echo $e->getMessage() . "\n";
    exit;
}


?>
