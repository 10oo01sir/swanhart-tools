#!/bin/bash
if [ "$1" = "" ]
then
  echo "Starting one of each type worker per core...";
  workers=$(cat /proc/cpuinfo | grep processor|wc -l)
  echo "Detected $workers cores"
else
  echo "Starting only $1 of each type of worker"
  workers=$1
fi

#wait for the config file to show up before trying to
#actually start any workers
IS_CONFIGURED=$(./check_for_config_file)
if [ "$IS_CONFIGURED" == "NO" ]; then
  echo "Did not find bootstrap file!  Please configure shard-query before starting workers."
fi

while [ "$IS_CONFIGURED" == "NO" ]
do
  echo "waiting for bootstrap (hit ctrl-c to cancel)..."
  sleep 2
  IS_CONFIGURED=$(./check_for_config_file)
done

for i in `seq 1 $workers`
do
  ./run_worker store_resultset >> ../log/store_resultset.log &
  ./run_worker new_loader >> ../log/new_loader.log &
  ./run_worker splitter >> ../log/splitter.log &
  ./run_worker shard_query_worker >> ../log/shard_query_worker.log &
  ./run_worker custom_function >> ../log/custom_function.log &
done
echo "done.."
